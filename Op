local SilentAimModule = {}

local VSkillModule = loadstring(game:HttpGet("https://raw.githubusercontent.com/jaanu91/Ip/refs/heads/main/Kata"))()

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local char = player.Character or player.CharacterAdded:Wait()
local camera = workspace.CurrentCamera
local RS = game:GetService("ReplicatedStorage")
local commE = RS:WaitForChild("Remotes"):WaitForChild("CommE")

local Services = setmetatable({}, {
    __index = function(self, serviceName)
        local good, service = pcall(game.GetService, game, serviceName);
        if (good) then
            self[serviceName] = service
            return service;
        end
    end
});

local SilentAimPlayersEnabled = false
local SilentAimNPCsEnabled = false
local UserWantsPlayerAim = false
local UserWantsNPCAim = false
local PredictionEnabled = false
local AutoKen = false
local Skills = {"Z", "X", "C", "V", "F"}

local Playersaimbot = nil
local PlayersPosition = nil
local NPCaimbot = nil
local NPCPosition = nil
local currentHighlight = nil
local currentTargetType = nil
local SelectedPlayer = nil

local PredictionAmount = 0.1
local maxRange = 1000

local function getHRP(model)
	if not model or not model:FindFirstChild("HumanoidRootPart") then return nil end
	return model.HumanoidRootPart
end

local function getPredictedPosition(hrp)
	if not hrp then return nil end
	if not PredictionEnabled then
		return hrp.Position
	end
	return hrp.Position + (hrp.Velocity * PredictionAmount)
end

-- =========================
-- Team Check
-- =========================
local function isAllyWithMe(targetPlayer)
	local myGui = player:FindFirstChild("PlayerGui")
	if not myGui then return false end

	local scrolling = myGui:FindFirstChild("Main")
		and myGui.Main:FindFirstChild("Allies")
		and myGui.Main.Allies:FindFirstChild("Container")
		and myGui.Main.Allies.Container:FindFirstChild("Allies")
		and myGui.Main.Allies.Container.Allies:FindFirstChild("ScrollingFrame")

	if scrolling then
		for _, frame in pairs(scrolling:GetDescendants()) do
			if frame:IsA("ImageButton") and frame.Name == targetPlayer.Name then
				return true
			end
		end
	end

	return false
end

local function isEnemy(targetPlayer)
	if not targetPlayer or targetPlayer == player then
		return false
	end

	local myTeam = player.Team
	local targetTeam = targetPlayer.Team

	if myTeam and targetTeam then
		if myTeam.Name == "Pirates" and targetTeam.Name == "Marines" then
			return true
		elseif myTeam.Name == "Marines" and targetTeam.Name == "Pirates" then
			return true
		end

		if myTeam.Name == "Pirates" and targetTeam.Name == "Pirates" then
			if isAllyWithMe(targetPlayer) then
				return false -- ally, not enemy
			end
			return true
		end

		if myTeam.Name == "Marines" and targetTeam.Name == "Marines" then
			return false
		end
	end

	return true
end

local function getClosestPlayer(lpHRP)
	if not lpHRP then return nil end
	
	local closest = nil
	local closestDist = math.huge
	for _, pl in ipairs(Players:GetPlayers()) do
		if pl ~= player and isEnemy(pl) and pl.Character and pl.Character.Parent ~= nil then
			local hum = pl.Character:FindFirstChildWhichIsA("Humanoid")
			local hrp = getHRP(pl.Character)
			if hum and hum.Health > 0 and hrp then
				local dist = (hrp.Position - lpHRP.Position).Magnitude
				if dist <= maxRange and dist < closestDist then
					closestDist = dist
					closest = pl
				end
			end
		end
	end
	return closest
end

local function getClosestNPC(lpHRP)
    if not lpHRP then return nil end

    local enemiesFolder = workspace:FindFirstChild("Enemies")
    if not enemiesFolder then return nil end

    local closest = nil
    local closestDist = math.huge
    for _, npc in ipairs(enemiesFolder:GetChildren()) do
        if npc:IsA("Model") then
            local hum = npc:FindFirstChildWhichIsA("Humanoid")
            local hrp = getHRP(npc)
            if hum and hum.Health > 0 and hrp then
                local dist = (hrp.Position - lpHRP.Position).Magnitude
                if dist <= maxRange and dist < closestDist then
                    closestDist = dist
                    closest = npc
                end
            end
        end
    end
    return closest
end

local function applyHighlight(targetModel, targetType)
    if not targetModel then return end
    if currentHighlight and currentHighlight.Adornee == targetModel then return end

    if currentHighlight then  
        currentHighlight:Destroy()  
        currentHighlight = nil  
        currentTargetType = nil  
    end  

    local hl = Instance.new("Highlight")  
    hl.FillColor = Color3.fromRGB(255, 255, 0)  
    hl.OutlineColor = Color3.fromRGB(255, 255, 0)  
    hl.FillTransparency = 0.5  
    hl.OutlineTransparency = 0  
    hl.Adornee = targetModel  
    hl.Parent = targetModel  
    currentHighlight = hl  
    currentTargetType = targetType

    VSkillModule:CheckVSkillUsage(SilentAimModule)
end

local function clearHighlight()
    if currentHighlight then
        currentHighlight:Destroy()
        currentHighlight = nil
        currentTargetType = nil
    end
end

RunService.Heartbeat:Connect(function()
    local lpChar = player.Character
    if not lpChar then return end
    local lpHRP = lpChar:FindFirstChild("HumanoidRootPart")
    if not lpHRP then return end

    local targetModel = nil

    if SilentAimPlayersEnabled then
		local targetPlayer = SelectedPlayer or getClosestPlayer(lpHRP)
		if targetPlayer and targetPlayer ~= player and targetPlayer.Character then
			Playersaimbot = targetPlayer.Name
			local hrp = getHRP(targetPlayer.Character)
			PlayersPosition = getPredictedPosition(hrp)
			targetModel = targetPlayer.Character
			applyHighlight(targetModel, "Player")
		else
			Playersaimbot, PlayersPosition = nil, nil
		end
	elseif currentTargetType == "Player" then
		Playersaimbot, PlayersPosition = nil, nil
		clearHighlight()
	end

	if SilentAimNPCsEnabled then  
	    local closestNPC = getClosestNPC(lpHRP)  
	    if closestNPC then  
	        NPCaimbot = closestNPC.Name  
	        local hrp = getHRP(closestNPC)  
	        NPCPosition = getPredictedPosition(hrp)  
	        if not targetModel then  
	            targetModel = closestNPC  
	            applyHighlight(targetModel, "NPC")  
	        end  
	    else  
	        NPCaimbot, NPCPosition = nil, nil  
	    end  
	elseif currentTargetType == "NPC" then
	    NPCaimbot, NPCPosition = nil, nil  
	    clearHighlight()
	end
end)

task.spawn(function()
    local OldHook
    local ok, hm = pcall(function() return hookmetamethod end)
    if not ok or not hm then return end

    OldHook = hookmetamethod(game, "__namecall", function(self, V1, V2, ...)
        local Method = getnamecallmethod and getnamecallmethod():lower() or ""

        if tostring(self) == "RemoteEvent" and Method == "fireserver" then
            if typeof(V1) == "Vector3" then
                local lpHRP = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
                if lpHRP then
                    local nearestPlayer = SilentAimPlayersEnabled and getClosestPlayer(lpHRP)
                    local nearestNPC = SilentAimNPCsEnabled and getClosestNPC(lpHRP)
                    local targetPart = nil

                    if nearestPlayer and SilentAimPlayersEnabled then
                        targetPart = getHRP(nearestPlayer.Character)
                    elseif nearestNPC and SilentAimNPCsEnabled then
                        targetPart = getHRP(nearestNPC)
                    end

                    if targetPart then
                        local predictedPos = getPredictedPosition(targetPart)
                        return OldHook(self, predictedPos, V2, ...)
                    end
                end
            end
        elseif Method == "invokeserver" then
            if type(V1) == "string" then
                if table.find(Skills, V1) and typeof(V2) == "Vector3" then
                    local lpHRP = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
                    if lpHRP then
                        local nearestPlayer = SilentAimPlayersEnabled and getClosestPlayer(lpHRP)
                        local nearestNPC = SilentAimNPCsEnabled and getClosestNPC(lpHRP)
                        local targetPart = nil

                        if nearestPlayer and SilentAimPlayersEnabled then
                            targetPart = getHRP(nearestPlayer.Character)
                        elseif nearestNPC and SilentAimNPCsEnabled then
                            targetPart = getHRP(nearestNPC)
                        end

                        if targetPart then
                            local predictedPos = getPredictedPosition(targetPart)
                            return OldHook(self, V1, predictedPos, targetPart, ...)
                        end
                    end
                end
            end
        end

        return OldHook(self, V1, V2, ...)
    end)
end)

local HasTag = function(tagName)
  local char = player.Character
  if (not char) then return false; end
  return Services.CollectionService:HasTag(char, tagName);
end

task.spawn(function()
	while true do
		local char = player.Character or player.CharacterAdded:Wait();
		char:WaitForChild("Humanoid");
		char:WaitForChild("HumanoidRootPart");
		wait(.1);
		if AutoKen then
		    if HasTag("Ken") then
				local PlayerGui = player:FindFirstChild("PlayerGui")
		        if PlayerGui then
		            local kenButton = PlayerGui:FindFirstChild("MobileContextButtons")
	                and PlayerGui.MobileContextButtons:FindFirstChild("ContextButtonFrame")
	                and PlayerGui.MobileContextButtons.ContextButtonFrame:FindFirstChild("BoundActionKen")

		            if kenButton and kenButton:GetAttribute("Selected") ~= true then
		                kenButton:SetAttribute("Selected", true)
		            end
		        end
		
		        local observationManager = getrenv()._G.OM;
		        if (observationManager and not observationManager.active) then
					observationManager.radius = 0
		            observationManager:setActive(true);
		            commE:FireServer("Ken", true);
		        end
		    end
		    wait();
		end
	end
end);

function SilentAimModule:SetAutoKen(state)
	AutoKen = state
end

function SilentAimModule:SetPlayerSilentAim(state)
	UserWantsPlayerAim = state
	SilentAimPlayersEnabled = state
end

function SilentAimModule:SetNPCSilentAim(state)
	UserWantsNPCAim = state
	SilentAimNPCsEnabled = state
end

function SilentAimModule:Pause()
    SilentAimPlayersEnabled = false
    SilentAimNPCsEnabled = false
end

function SilentAimModule:Restore()
    SilentAimPlayersEnabled = UserWantsPlayerAim
    SilentAimNPCsEnabled = UserWantsNPCAim
end

function SilentAimModule:IsPlayerAimEnabled()
    return SilentAimPlayersEnabled
end

function SilentAimModule:IsNPCAimEnabled()
    return SilentAimNPCsEnabled
end

function SilentAimModule:SetDistanceLimit(num)
	if typeof(num) == "number" then
		maxRange = num
	end
end

function SilentAimModule:SetSelectedPlayer(playerName)
	if not playerName or playerName == "" then
		SelectedPlayer = nil
		return
	end

	local found = Players:FindFirstChild(playerName)
	if found then
		SelectedPlayer = found
	end
end

function SilentAimModule:GetSelectedPlayer()
	return SelectedPlayer and SelectedPlayer.Name or "None"
end

function SilentAimModule:SetPrediction(state)
	PredictionEnabled = state
end

function SilentAimModule:SetPredictionAmount(num)
	if typeof(num) == "number" then
		PredictionAmount = num
	end
end

return SilentAimModule
