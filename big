-- HelperGodhumanZAim.lua
local HelperGodhumanZ = {}

local UserInputService = game:GetService("UserInputService")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local camera = workspace.CurrentCamera

local player = Players.LocalPlayer
local char = player.Character or player.CharacterAdded:Wait()

local currentTool = nil
local rightTouches = {}

local GodhumanZEnabled = false
local zActive = false
local maxRange = 1000

local function getHRP(model)
	return model and model:FindFirstChild("HumanoidRootPart")
end

-- Closest Player
local function getClosestPlayer(lpHRP)
	local closest, closestDist = nil, math.huge
	for _, pl in ipairs(Players:GetPlayers()) do
		if pl ~= player and pl.Character and pl.Character.Parent then
			local hum = pl.Character:FindFirstChildOfClass("Humanoid")
			local hrp = getHRP(pl.Character)
			if hum and hum.Health > 0 and hrp then
				local dist = (hrp.Position - lpHRP.Position).Magnitude
				if dist <= maxRange and dist < closestDist then
					closestDist, closest = dist, pl.Character
				end
			end
		end
	end
	return closest
end

-- Closest NPC
local function getClosestNPC(lpHRP)
	local enemiesFolder = workspace:FindFirstChild("Enemies")
	if not enemiesFolder then return nil end

	local closest, closestDist = nil, math.huge
	for _, npc in ipairs(enemiesFolder:GetChildren()) do
		if npc:IsA("Model") and npc:FindFirstChild("Humanoid") then
			local hum = npc:FindFirstChild("Humanoid")
			local hrp = getHRP(npc)
			if hum and hum.Health > 0 and hrp then
				local dist = (hrp.Position - lpHRP.Position).Magnitude
				if dist <= maxRange and dist < closestDist then
					closestDist, closest = dist, npc
				end
			end
		end
	end
	return closest
end

-- Handle tool
local function hookTool(tool)
	currentTool = tool
	tool.AncestryChanged:Connect(function(_, parent)
		if not parent then
			currentTool = nil
			zActive = false
		end
	end)
end

char.ChildAdded:Connect(function(child)
	if child:IsA("Tool") then
		hookTool(child)
	end
end)

char.ChildRemoved:Connect(function(child)
	if child == currentTool then
		currentTool = nil
		zActive = false
	end
end)

-- Aim activation (no silent aim module)
local function activateAimlock()
	if not GodhumanZEnabled or not zActive then return end

	local hrp = char:FindFirstChild("HumanoidRootPart")
	if not hrp then return end

	local target = getClosestPlayer(hrp) or getClosestNPC(hrp)
	if not target then return end

	local targetHRP = target:FindFirstChild("HumanoidRootPart")
	if not targetHRP then return end

	local startTime = tick()
	local conn
	conn = RunService.RenderStepped:Connect(function()
		-- small safeguard in case ability should not last long
		if tick() - startTime > 1 then
			conn:Disconnect()
			zActive = false
			return
		end
		-- only change camera orientation (not position)
		camera.CFrame = CFrame.new(camera.CFrame.Position, targetHRP.Position)
	end)
end

-- Detect Z usage via namecall hook (exploit environment)
do
	local old
	old = hookmetamethod(game, "__namecall", function(self, ...)
		local method = getnamecallmethod()
		local args = { ... }

		if (method == "InvokeServer" or method == "FireServer") then
			local a1 = args[1]
			-- detect Z being sent (case-insensitive)
			if typeof(a1) == "string" and a1:upper() == "Z" then
				-- only act if holding Godhuman
				if currentTool and currentTool.Name == "Godhuman" then
					-- mark zActive and run aim immediately (debounced below)
					zActive = true
					activateAimlock()
				end
			end
		end

		return old(self, ...)
	end)
end

-- Mobile touch detection (keeps original right-side touch logic)
UserInputService.TouchStarted:Connect(function(touch)
	if touch.Position.X > camera.ViewportSize.X / 2 then
		rightTouches[touch] = true
	end
end)

UserInputService.TouchEnded:Connect(function(touch)
	if rightTouches[touch] then
		rightTouches[touch] = nil
		-- we keep this so you can also trigger on lift if desired
		if not next(rightTouches) then
			if zActive then
				-- already handled in namecall hook; this is an extra safety
				activateAimlock()
			end
		end
	end
end)

function HelperGodhumanZ:SetGodhumanZ(state)
	GodhumanZEnabled = state and true or false
end

function HelperGodhumanZ:IsEnabled()
	return GodhumanZEnabled
end

return HelperGodhumanZ
