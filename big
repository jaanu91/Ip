-- HelperGodhumanZAim.lua
local HelperGodhumanZ = {}

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local camera = workspace.CurrentCamera

local player = Players.LocalPlayer
local char = player.Character or player.CharacterAdded:Wait()

local GodhumanZEnabled = false
local zActive = false
local maxRange = 1000

-- store reference to SilentAimModule
local SilentAimModule = nil
function HelperGodhumanZ:SetSilentAimModule(module)
    SilentAimModule = module
end

local function getHRP(model)
	return model and model:FindFirstChild("HumanoidRootPart")
end

local function getClosestPlayer(lpHRP)
	local closest, closestDist = nil, math.huge
	for _, pl in ipairs(Players:GetPlayers()) do
		if pl ~= player and pl.Character and pl.Character.Parent then
			local hum = pl.Character:FindFirstChildOfClass("Humanoid")
			local hrp = getHRP(pl.Character)
			if hum and hum.Health > 0 and hrp then
				local dist = (hrp.Position - lpHRP.Position).Magnitude
				if dist <= maxRange and dist < closestDist then
					closestDist, closest = dist, pl.Character
				end
			end
		end
	end
	return closest
end

local function getClosestNPC(lpHRP)
	local enemiesFolder = workspace:FindFirstChild("Enemies")
	if not enemiesFolder then return nil end

	local closest, closestDist = nil, math.huge
	for _, npc in ipairs(enemiesFolder:GetChildren()) do
		if npc:IsA("Model") and npc:FindFirstChild("Humanoid") then
			local hum = npc:FindFirstChild("Humanoid")
			local hrp = getHRP(npc)
			if hum and hum.Health > 0 and hrp then
				local dist = (hrp.Position - lpHRP.Position).Magnitude
				if dist <= maxRange and dist < closestDist then
					closestDist, closest = dist, npc
				end
			end
		end
	end
	return closest
end

local function activateAimlock()
	if not GodhumanZEnabled or not zActive or not SilentAimModule then return end

	local hrp = char:FindFirstChild("HumanoidRootPart")
	if not hrp then return end

	local target = nil

	if SilentAimModule:IsPlayerSilentAim() then
		target = getClosestPlayer(hrp)
	elseif SilentAimModule:IsNPCSilentAim() then
		target = getClosestNPC(hrp)
	end

	if not target then return end
	local targetHRP = getHRP(target)
	if not targetHRP then return end

	local startTime = tick()
	local conn
	conn = RunService.RenderStepped:Connect(function()
		if tick() - startTime > 1 then
			conn:Disconnect()
			zActive = false
			return
		end
		camera.CFrame = CFrame.new(camera.CFrame.Position, targetHRP.Position)
	end)
end

-- detect Godhuman Z
do
	local old
	old = hookmetamethod(game, "__namecall", function(self, ...)
		local method = getnamecallmethod()
		local args = { ... }

		if (method == "InvokeServer" or method == "FireServer") then
			local a1 = args[1]
			if typeof(a1) == "string" and a1:upper() == "Z" then
				if char:FindFirstChildWhichIsA("Tool") and char:FindFirstChildWhichIsA("Tool").Name == "Godhuman" then
					zActive = true
					activateAimlock()
				end
			end
		end
		return old(self, ...)
	end)
end

function HelperGodhumanZ:SetGodhumanZ(state)
	GodhumanZEnabled = state and true or false
end

return HelperGodhumanZ
